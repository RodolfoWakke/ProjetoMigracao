<transformation>
  <info>
    <name>05 - PASSO 5 - FIN</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection/>
        <schema/>
        <table/>
        <size_limit_lines/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject/>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject/>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject/>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject/>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection/>
        <schema/>
        <table/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2023/03/02 15:42:02.689</created_date>
    <modified_user>-</modified_user>
    <modified_date>2023/04/20 16:57:18.580</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
    <notepad>
      <note>FINANCEIRO</note>
      <xloc>64</xloc>
      <yloc>64</yloc>
      <width>119</width>
      <heigth>34</heigth>
      <fontname>Segoe UI</fontname>
      <fontsize>9</fontsize>
      <fontbold>Y</fontbold>
      <fontitalic>N</fontitalic>
      <fontcolorred>255</fontcolorred>
      <fontcolorgreen>255</fontcolorgreen>
      <fontcolorblue>255</fontcolorblue>
      <backgroundcolorred>0</backgroundcolorred>
      <backgroundcolorgreen>128</backgroundcolorgreen>
      <backgroundcolorblue>0</backgroundcolorblue>
      <bordercolorred>100</bordercolorred>
      <bordercolorgreen>100</bordercolorgreen>
      <bordercolorblue>100</bordercolorblue>
      <drawshadow>Y</drawshadow>
    </notepad>
    <notepad>
      <note>REVER CONTASRECEBER QUE ESTÃO PARA O ALUNO 999999999 'EMPRESA/CONTASRECEBER'.
TODAS OS REGISTROS DE PARCELA QUE ESTAVAM PARA O ALUNO 0, FORAM COLOCADAS PARA O 'ALUNO' ACIMA.
</note>
      <xloc>208</xloc>
      <yloc>128</yloc>
      <width>625</width>
      <heigth>57</heigth>
      <fontname>Segoe UI</fontname>
      <fontsize>9</fontsize>
      <fontbold>N</fontbold>
      <fontitalic>N</fontitalic>
      <fontcolorred>255</fontcolorred>
      <fontcolorgreen>255</fontcolorgreen>
      <fontcolorblue>255</fontcolorblue>
      <backgroundcolorred>0</backgroundcolorred>
      <backgroundcolorgreen>128</backgroundcolorgreen>
      <backgroundcolorblue>192</backgroundcolorblue>
      <bordercolorred>100</bordercolorred>
      <bordercolorgreen>100</bordercolorgreen>
      <bordercolorblue>100</bordercolorblue>
      <drawshadow>Y</drawshadow>
    </notepad>
  </notepads>
  <connection>
    <name>RDS</name>
    <server>${v_end-RDS}</server>
    <type>MYSQL</type>
    <access>Native</access>
    <database>${v_nomebanco-RDS}</database>
    <port>3306</port>
    <username>root</username>
    <password>Encrypted 2be98afc86aa78195a71aa271cb96a6db</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>EXTRA_OPTION_MYSQL.defaultFetchSize</code>
        <attribute>500</attribute>
      </attribute>
      <attribute>
        <code>EXTRA_OPTION_MYSQL.useCursorFetch</code>
        <attribute>true</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
  </order>
  <step>
    <name>SCRIPT FINANCEIRO</name>
    <type>ExecSQL</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>RDS</connection>
    <execute_each_row>N</execute_each_row>
    <single_statement>N</single_statement>
    <replace_variables>N</replace_variables>
    <quoteString>N</quoteString>
    <sql>DROP TRIGGER IF EXISTS TAI_PAGAMENTOFORMA;
DROP TRIGGER IF EXISTS TAI_LIQUIDACAOBOLETO;
DROP TRIGGER IF EXISTS TBD_LIQUIDACAOBOLETO;
DROP TRIGGER IF EXISTS TBI_LIQUIDACAOBOLETO;
DROP TRIGGER IF EXISTS TAU_CONTASRECEBER;
DROP TRIGGER IF EXISTS TBD_CONTASRECEBER;
DROP TRIGGER IF EXISTS TBI_CONTASRECEBER;
DROP TRIGGER IF EXISTS TBU_CONTASRECEBER;

DELETE FROM itenscaixa;
DELETE FROM caixa;
DELETE FROM liquidestornadas;
DELETE FROM contasreceberexcluida;
DELETE FROM usuarioconta;
DELETE FROM pagamentoforma;
DELETE FROM liquidacaoboleto;
DELETE FROM pagamento;
DELETE FROM contasreceber;
DELETE FROM contrato;
DELETE FROM conta;
DELETE FROM centroreceita;

ALTER TABLE centroreceita AUTO_INCREMENT = 1;
ALTER TABLE contasreceber AUTO_INCREMENT = 1;
ALTER TABLE liquidacaoboleto AUTO_INCREMENT = 1;
ALTER TABLE pagamento AUTO_INCREMENT = 1;
ALTER TABLE contasreceber AUTO_INCREMENT = 1;
ALTER TABLE centroreceita AUTO_INCREMENT = 1;
ALTER TABLE contrato AUTO_INCREMENT = 1;


-- MIG_CONTASRECEBER UPDATES -- 

-- PREENCHER CODMATRICULA PARTE 1
update mig_contasreceber ca 
set ca.codmatricula = (select max(m.codmatricula) from matricula m where m.codaluno = ca.codaluno and m.anoletivo = ca.anoletivo);

-- PREENCHER CODMATRICULA PARTE 2
update mig_contasreceber ca 
set ca.codmatricula = (select max(m.codmatricula) from matricula m where m.codaluno = ca.codaluno)
where ca.codmatricula is NULL;

-- PREENCHER OUTRASRECEITAS
UPDATE mig_contasreceber c SET c.outrasreceitas = 'S' WHERE c.codmatricula IS NULL;

-- PREENCHER CPF'S VAZIOS
UPDATE mig_contasreceber c
JOIN matricula m ON m.codmatricula = c.codmatricula
SET c.cpf = m.cpfrespfinanceiro
where c.cpf is NULL;

-- PREENCHER CODUNIDADE
UPDATE mig_contasreceber c 
JOIN matricula m ON m.codmatricula = c.codmatricula
SET c.codunidade = m.codunidade;


-- PREENCHER RECEITAORIGINAL
UPDATE mig_contasreceber
SET receitaoriginal = codreceita;


-- AJUSTAR TOTPARCELA
UPDATE mig_contasreceber c
LEFT JOIN (SELECT codmatricula, MAX(parcela) AS totparcela
FROM contasreceber
GROUP BY codmatricula) d
ON c.codmatricula = d.codmatricula
SET c.totparcela = d.totparcela;

-- LIMPAR ONDE O VALORPAGO É 0
UPDATE mig_contasreceber
SET valorpago = NULL
WHERE valorpago = 0;





-- ---------------------------------------------------------------
-- ---------------------------------------------------------------

-- CENTRORECEITA

INSERT INTO centroreceita
SELECT codreceita, dscreceita, ativo, multa, juros, codnaturezalanccaixa, carenciamulta, carenciadesconto, percentualdesconto, codcontacaixa, principal, jurossobre, msgfixaboleto, atualizajuros, desconto2sobre, podeagrupar, conluimatriculaonline, cobrancaautomatica, cieloativo, tipocobrancaiugu, competencia, opcional, alteradopor, dtalteracao 
FROM mig_centroreceita c GROUP BY c.dscreceita;


UPDATE mig_centroreceita c
JOIN centroreceita a ON (c.dscreceita = a.dscreceita)
SET c.codreceita_unificado = a.codreceita;

-- ---------------------------------------------------------------
-- CONTA

INSERT INTO conta
SELECT codconta, dscconta, codempresa, codbanco, agencia, numconta, numdigitoconta, chequeespecial, saldoinicio, tipoconta, bancaria, ativo, agenciacodcedante, carteira, localpagamento, codbancodigito, especie, carteiraboleto, digitoagencia, codcedente, codtransmissao, codmsg1, codmsg2, msgremessa, idcontafacil, recbancoaposvenc, tipoarquivoremessa, tipoarquivoretorno, variacaocarteirabancobrasil, modalidadecarteirasicoob, protestotitulo, postocooperativasicredi, diasparaprotesto, codoperacao, sequencialremessa, homologada, dtmologacao, tecnicohomologacao, instrucaoboleto, diasdevolucao, boletofacil, dtsaldoinicio, conveniodda, diasnegativacao, emissaobanco, codigoparabaixa, codmeiopagamento, codnaturezameiopagamento, codcontavinculada, codnaturezatarifa, codnaturezaantecipacao, dataalteracao, usuarioalteracao, versaolayoutremessa
FROM mig_conta;

-- ---------------------------------------------------------------
-- CONTASRECEBER

INSERT INTO contasreceber
SELECT c.codrec, c.codmatricula, c.parcela, c.totparcela, c.valorparcela, c.vencimento, c.desconto, c.desconto_antesfatura, c.carenciadesconto, c.vencimentodesconto, c.desconto2, c.desconto2_antesfatura, c.carenciadesconto2, c.vencimentodesconto2, c.desconto3, c.desconto3_antesfatura, c.carenciadesconto3, c.vencimentodesconto3, c.multa, c.juros, c.carenciamulta, c.vencimentomulta, c.dtpagamento, c.valorpago, c.recebidopor, c.codunidade, c.anoletivo, cr.codreceita_unificado, c.codcontapago, a.codaluno_unificado, c.nossonumero, c.linha, c.barra, c.cobbancaria, c.codconta, c.incluidotabrps, c.codliquidacao, c.avulsa, c.cadastradopor, c.dtcadastro, c.valorparcelaoriginal, c.descontooriginal, c.vencimentooriginal, c.enviaremessa, c.codremessa, c.cobregistradabanco, c.alteradopor, c.codnegociacao, c.valornegociado, c.abatimento, c.abatimento_antesfatura, c.valorbruto, c.codcontrato, c.codfornecedor, c.outrasreceitas, c.descricao, c.codrecfatura, c.codlotefatura, c.CPF, c.vencfatura, c.vencfaturadesc, c.vencfaturadesc2, c.vencfaturamulta, cr.codreceita_unificado, c.codinscricaoevento, c.codremessaalteracao, c.faturaunica, c.outrosacrescimos, c.outrosabatimentos, c.valor, c.codsolicitacao, c.carenciadesconto1original, c.carenciadesconto2original, c.carenciamultaoriginal, c.registroconfirmado, c.carenciadesconto3original, c.idfaturaiugu, c.statusparcela, c.boletourl, c.parcelaremessasicoob, c.tipocobrancaiugu, c.tipocobrancaiuguoriginal, c.dtcompetencia, c.dtcompetencia_antesfatura, c.cobrancaexterna, c.gabrielsetoucodunidade 
FROM mig_contasreceber c
JOIN mig_centroreceita cr ON (c.codreceita = cr.codreceita)
lEFT JOIN mig_aluno a ON (a.codaluno = c.codaluno);

-- CONTRATO PARA OUTRAS RECEITAS

INSERT INTO contrato (codtipocontrato, codunidade, codfornecedor,cpfrespfinanceiro, anoletivo, situacao, dtcadastro, cadastradopor)
(SELECT 0, 1, 0, cr.CPF, cr.anoletivo, 'C', CURDATE(), 'MIG AUTO'
FROM contasreceber cr WHERE cr.outrasreceitas = 'S' GROUP BY cr.CPF);

-- UPDATE CONTASRECEBER SETANDO CODCONTRATO

UPDATE contasreceber cr
JOIN contrato c ON (cr.CPF = c.cpfrespfinanceiro)
SET cr.codcontrato = c.codcontrato;

-- DElETE EM CENTRORECEITA DUPLICADO OU QUE NÃO É USADO EM CONTASRECEBER

DELETE c FROM centroreceita c WHERE c.codreceita NOT IN (SELECT codreceita FROM contasreceber);

-- ---------------------------------------------------------------
-- LIQUIDACAOBOLETO

INSERT INTO liquidacaoboleto(codreceita, valorpago, dtpagamento, codaluno, anoletivo, parcela, conta  ,vencimento  ,nossonumero,
valorapagar, desconto, valorparcela, dtprocessamento, codrec, usuario)
(SELECT 
c.codreceita, 
c.valorpago, 
c.dtpagamento, 
c.codaluno, 
c.anoletivo, 
c.parcela,
c.codconta, 
c.vencimento, 
c.nossonumero, 
c.valorparcela, 
(c.desconto) as desconto, 
c.valorparcela, 
c.dtpagamento, 
c.codrec, 
'MIG AUTO'
FROM contasreceber c
WHERE c.dtpagamento IS NOT NULL);

-- PAGAMENTO

INSERT INTO pagamento(codpagamento ,dtpagamento ,dtregistro ,registradopor ,codunidaderec ,totalpago ,obs ,codaluno ,cpfresp)
select l.codliquidacao as codpagamento, l.dtpagamento, l.dtprocessamento , l.usuario, c.codunidade, l.valorpago, l.obspagamento, l.codaluno, c.cpf
from liquidacaoboleto l
join contasreceber c ON c.codrec = l.codrec
where l.codpagamento is NULL;

-- PAGAMENTOFORMA

INSERT INTO pagamentoforma(codpagamento ,codconta ,valorpago ,codmeiopagamentoitem ,codforma)
select l.codliquidacao as codpagamento, c.codconta AS codconta, l.valorpago, null,
(CASE l.formapagamento
WHEN 'DI' THEN 1
WHEN 'LI' THEN 2
WHEN 'CD' THEN 4
WHEN 'CC' THEN 5
ELSE 1 END) AS codforma
from liquidacaoboleto l
join contasreceber c ON c.codrec = l.codrec
where l.codpagamento is NULL;


-- UPDATE LIQUIDACAOBOLETO

update liquidacaoboleto l
set l.codpagamento = l.codliquidacao
where l.codpagamento is null;


-- -----------------------------------------------------

</sql>
    <set_params>N</set_params>
    <insert_field/>
    <update_field/>
    <delete_field/>
    <read_field/>
    <arguments>
    </arguments>
    <attributes/>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>128</xloc>
      <yloc>128</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
  <attributes/>
</transformation>
